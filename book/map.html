<!DOCTYPE html>
<html lang="ko">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>ì¥ì†Œê²€ìƒ‰ ë° ì…ë ¥</title>

  <!-- íŒŒë¹„ì½˜ ì•„ì´ì½˜ë“¤ -->
  <link rel="icon" href="/favicon.png?v=2" />
  <link rel="icon" type="image/png" sizes="36x36" href="./favicons/2/android-icon-36x36.png" />
  <link rel="icon" type="image/png" sizes="48x48" href="./favicons/2/android-icon-48x48.png" />
  <link rel="icon" type="image/png" sizes="72x72" href="./favicons/2/android-icon-72x72.png" />
  <link rel="apple-touch-icon" sizes="32x32" href="./favicons/2/apple-icon-32x32.png">
  <link rel="apple-touch-icon" sizes="57x57" href="./favicons/2/apple-icon-57x57.png">
  <link rel="apple-touch-icon" sizes="60x60" href="./favicons/2/apple-icon-60x60.png">
  <link rel="apple-touch-icon" sizes="72x72" href="./favicons/2/apple-icon-72x72.png">

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">

  <!-- âœ… [ìˆ˜ì •ë¨] autoload=false íŒŒë¼ë¯¸í„° ì¶”ê°€ (ì—ëŸ¬ ë°©ì§€) -->
  <script
    src="//dapi.kakao.com/v2/maps/sdk.js?appkey=3409644aa1cb50eb41430562f5df97d2&libraries=services&autoload=false"></script>

  <style>
    /* ... (ê¸°ì¡´ ìŠ¤íƒ€ì¼ ë™ì¼ ìœ ì§€) ... */
    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      padding: 0;
      font-family: 'Noto Sans KR', sans-serif;
      background: #f0f2f5;
      color: #333;
    }

    .container {
      max-width: 600px;
      margin: 0 auto;
      padding: 20px;
      display: flex;
      flex-direction: column;
      min-height: 100vh;
    }

    h2 {
      text-align: center;
      margin-bottom: 15px;
      color: #2c3e50;
      font-size: 1.5rem;
    }

    .search-form {
      display: flex;
      gap: 10px;
      margin-bottom: 10px;
    }

    input[type="text"] {
      flex: 1;
      padding: 15px;
      font-size: 16px;
      border-radius: 12px;
      border: 1px solid #ccc;
      outline: none;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
    }

    input[type="text"]:focus {
      border-color: #4a90e2;
    }

    .btn-search {
      background-color: #4a90e2;
      color: white;
      border: none;
      border-radius: 12px;
      width: 55px;
      cursor: pointer;
      font-size: 1.2rem;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
      transition: background 0.2s;
    }

    .btn-search:active {
      background-color: #357abd;
    }

    #placesList {
      list-style: none;
      padding: 0;
      margin: 0 0 20px 0;
      background: white;
      border-radius: 12px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
      max-height: 200px;
      overflow-y: auto;
      display: none;
      position: relative;
      z-index: 100;
    }

    #placesList li {
      padding: 15px;
      border-bottom: 1px solid #eee;
      cursor: pointer;
    }

    #placesList li:last-child {
      border-bottom: none;
    }

    #placesList li:hover {
      background-color: #f9f9f9;
    }

    #placesList .place-name {
      font-weight: bold;
      font-size: 16px;
      color: #333;
      margin-bottom: 5px;
    }

    #placesList .place-addr {
      font-size: 13px;
      color: #777;
    }

    #placesList li.on {
      background-color: #e3f2fd;
      border-left: 5px solid #4a90e2;
    }

    .map-box {
      background: white;
      padding: 5px;
      border-radius: 15px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
      min-height: 300px;
      margin-top: 20px;
      margin-bottom: 20px;
      position: relative;
      display: none;
    }

    .map-box.show {
      display: block;
    }

    #map {
      width: 100%;
      height: 300px;
      border-radius: 10px;
    }

    .map-placeholder {
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 300px;
      color: #999;
      font-size: 1.1rem;
      text-align: center;
      padding: 40px;
      line-height: 1.8;
    }

    .button-group {
      display: flex;
      flex-direction: column;
      align-items: center;
      /* ê°€ë¡œ ì¤‘ì•™ì •ë ¬ */
      justify-content: center;
      /* ì„¸ë¡œ ì¤‘ì•™ì •ë ¬ (í•„ìš”ì‹œ) */
      gap: 10px;
      margin-top: auto;
      padding-top: 20px;
    }

    .btn-link {
      display: block;
      width: 100%;
      text-align: center;
      margin-top: 15px;
      padding: 16px;
      font-size: 18px;
      font-weight: bold;
      border-radius: 12px;
      text-decoration: none;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      transition: all 0.2s;
      border: none;
      cursor: pointer;
    }

    .btn-preview {
      background-color: #34c759;
      color: white;
    }

    .btn-preview:active {
      background-color: #2da94b;
      transform: translateY(2px);
    }

    .btn-preview:disabled {
      background-color: #ccc;
      cursor: not-allowed;
      opacity: 0.6;
    }

    .btn-send {
      background-color: #4a90e2;
      color: white;
      margin-top: 15px;
    }

    .btn-send:active {
      background-color: #357abd;
      transform: translateY(2px);
    }

    .btn-send:disabled {
      background-color: #ccc;
      cursor: not-allowed;
      opacity: 0.6;
    }

    /* ë²„íŠ¼ ì˜ì—­ */
    .btn-area {
      margin-top: 30px;
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      justify-content: center;
    }

    .btn-same {
      width: 100%;
      max-width: 300px;
      padding: 14px 34px !important;
      font-size: 1.15rem !important;
    }
  </style>
</head>

<body>
  <div class="container">

    <h2>
      <img src="image/location-30.png" alt="ğŸ“" width="30" height="30" style="vertical-align: middle;">
      ì¥ì†Œ/ì£¼ì†Œ ê²€ìƒ‰
    </h2>

    <form class="search-form" id="searchForm">
      <input type="text" id="keyword" placeholder="ì£¼ì†Œ(ì§€ë²ˆ/ë„ë¡œëª…) ë˜ëŠ” ê±´ë¬¼ëª… ì…ë ¥" autocomplete="off">
      <button type="submit" class="btn-search">ğŸ”</button>
    </form>

    <div style="margin-bottom:10px;">
      <div style="font-weight:bold;margin-bottom:5px;">ëª¨ë‹¬ì°½ ìƒì„± ì•ˆë‚´ë¬¸</div>
      <textarea id="modalNotice" maxlength="500" rows="10"
        style="width:100%;padding:15px;font-size:16px;border-radius:12px;border:1px solid #ccc;resize:none;box-shadow:0 2px 5px rgba(0,0,0,0.05);text-align: left;white-space: pre-line;">ğŸ‰ ëª¨ì„ì œëª©:
ğŸ“… ëª¨ì„ë‚ ì§œ:
â° ì‹œê°„:
ğŸ“ ì¥ì†Œ:
ğŸ“¢ ì „ë‹¬ì‚¬í•­:

ğŸ“ ì•ˆë‚´ì‚¬í•­: ì•„ë˜ì˜ 'ì¹´ì¹´ì˜¤ë§µ' / 'TMAPì‹¤í–‰' ë²„íŠ¼ì„ í´ë¦­í•˜ë©´ ë„¤ë¹„ê²Œì´ì…˜ì´ ì¥ì†Œë¡œ ì•ˆë‚´í•©ë‹ˆë‹¤.
ì•±ì´ ì„¤ì¹˜ë˜ì–´ìˆì§€ì•Šìœ¼ë©´ ì„¤ì¹˜ í›„ ì´ìš©í•´ì£¼ì„¸ìš”.</textarea>
    </div>

    <ul id="placesList"></ul>

    <div class="map-box" id="mapBox">
      <div id="map"></div>
    </div>

    <div class="map-placeholder" id="mapPlaceholder">
      ğŸ“ ìœ„ì˜ ê²€ìƒ‰ì°½ì—ì„œ ì¥ì†Œ(ì£¼ì†Œ)ë¥¼ ê²€ìƒ‰í•˜ê³ <br>
      ëª©ë¡ì—ì„œ ì„ íƒí•œ í›„<br>
      "ğŸ—ºï¸ ì§€ë„ ë¯¸ë¦¬ë³´ê¸°" ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”
    </div>

    <div class="button-group">
      <button class="btn-link btn-preview" id="btnPreview" onclick="showMapPreview()" disabled
        style="width: 100%; max-width: 350px;">
        ğŸ—ºï¸ ì§€ë„ ë¯¸ë¦¬ë³´ê¸°
      </button>

      <button class="btn-link btn-send" id="btnSend" onclick="goToMapView()" disabled
        style="width: 100%; max-width: 350px;">
        ğŸ“¤ ì´ ìœ„ì¹˜ë¡œ ì§€ë„ ë³´ë‚´ê¸°
      </button>

      <button class="btn-link btn-secondary" style="width: 100%; max-width: 350px;"
        onclick="location.href='map_view.html'">
        ğŸ” ì§€ë„ ë³´ê¸°
      </button>

      <div class="btn-area text-center mt-5">
        <a href="index.html" class="btn btn-secondary btn-sm btn-same mt-2">âª ëŒì•„ê°€ê¸°</a>
      </div>
    </div>

  </div>

  <script type="module">
    // ì „ì—­ ë³€ìˆ˜ ì„ ì–¸
    let mapContainer, mapOption, map, marker, ps, geocoder;
    let selectedAddress = "";
    let selectedCoords = null;
    let isMapPreviewed = false;

    // âœ… [ìˆ˜ì •ë¨] ì¹´ì¹´ì˜¤ë§µ ë¡œë“œ í›„ ì‹¤í–‰ (ì—ëŸ¬ ë°©ì§€ í•µì‹¬)
    kakao.maps.load(function () {
      mapContainer = document.getElementById('map');
      mapOption = {
        center: new kakao.maps.LatLng(37.5665, 126.9780),
        level: 3
      };

      map = new kakao.maps.Map(mapContainer, mapOption);
      marker = new kakao.maps.Marker({ map: map });

      // ì¥ì†Œ ê²€ìƒ‰ ê°ì²´ & ì£¼ì†Œ-ì¢Œí‘œ ë³€í™˜ ê°ì²´ ìƒì„±
      ps = new kakao.maps.services.Places();
      geocoder = new kakao.maps.services.Geocoder();
    });

    // í¼ ì œì¶œ ì´ë²¤íŠ¸
    document.getElementById('searchForm').addEventListener('submit', function (e) {
      e.preventDefault();
      searchPlaces();
      document.getElementById('keyword').blur();
    });

    // ì—”í„°í‚¤ ì²˜ë¦¬
    document.getElementById('keyword').addEventListener('keypress', function (e) {
      if (e.key === 'Enter' || e.keyCode === 13) {
        e.preventDefault();
        searchPlaces();
        this.blur();
      }
    });

    // í†µí•© ê²€ìƒ‰ í•¨ìˆ˜ (í‚¤ì›Œë“œ + ì£¼ì†Œ)
    function searchPlaces() {
      const keyword = document.getElementById('keyword').value.trim();

      if (!keyword) {
        alert('ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”!');
        return false;
      }

      // ê²€ìƒ‰ ê²°ê³¼ ì´ˆê¸°í™”
      document.getElementById('placesList').style.display = 'none';
      document.getElementById('placesList').innerHTML = "";

      // 1. í‚¤ì›Œë“œ ê²€ìƒ‰ ì‹œë„
      ps.keywordSearch(keyword, function (data, status) {
        if (status === kakao.maps.services.Status.OK) {
          // í‚¤ì›Œë“œ ê²°ê³¼ê°€ ìˆìœ¼ë©´ ë°”ë¡œ í‘œì‹œ
          displayPlaces(data);
        } else {
          // 2. í‚¤ì›Œë“œ ê²°ê³¼ê°€ ì—†ìœ¼ë©´(ZERO_RESULT) -> ì£¼ì†Œ ê²€ìƒ‰ ì‹œë„
          geocoder.addressSearch(keyword, function (result, addrStatus) {
            if (addrStatus === kakao.maps.services.Status.OK) {
              // ì£¼ì†Œ ê²€ìƒ‰ ê²°ê³¼ í¬ë§·ì„ í‚¤ì›Œë“œ ê²°ê³¼ì™€ ë§ì¶¤
              const addrData = result.map(item => ({
                place_name: item.road_address ? item.road_address.address_name : item.address.address_name,
                address_name: item.address_name,
                road_address_name: item.road_address ? item.road_address.address_name : '',
                x: item.x,
                y: item.y
              }));
              displayPlaces(addrData);
            } else {
              // ë‘˜ ë‹¤ ì‹¤íŒ¨ ì‹œ
              alert('ê²€ìƒ‰ ê²°ê³¼ê°€ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
            }
          });
        }
      });
    }

    // ê²€ìƒ‰ ê²°ê³¼ ëª©ë¡ í‘œì¶œ (ê³µí†µ)
    function displayPlaces(places) {
      const listEl = document.getElementById('placesList');
      listEl.innerHTML = "";
      listEl.style.display = 'block';

      for (let i = 0; i < places.length; i++) {
        const itemEl = document.createElement('li');

        const addressName = places[i].road_address_name ? places[i].road_address_name : places[i].address_name;
        const placeName = places[i].place_name;

        itemEl.innerHTML = `
      <div class="place-name">${placeName}</div>
      <div class="place-addr">${addressName}</div>
    `;

        itemEl.onclick = function () {
          selectedCoords = new kakao.maps.LatLng(places[i].y, places[i].x);

          const children = listEl.children;
          for (let j = 0; j < children.length; j++) children[j].classList.remove('on');
          this.classList.add('on');

          // ì„ íƒëœ ì£¼ì†Œ ë˜ëŠ” ì¥ì†Œëª… ì €ì¥
          selectedAddress = placeName;

          document.getElementById('keyword').value = placeName;
          document.getElementById('btnPreview').disabled = false;
          isMapPreviewed = false;
          document.getElementById('btnSend').disabled = true;
        };

        listEl.appendChild(itemEl);
      }

      setTimeout(() => {
        listEl.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
      }, 100);
    }

    function showMapPreview() {
      if (!selectedCoords) {
        alert("ëª©ë¡ì—ì„œ ì¥ì†Œë¥¼ ë¨¼ì € ì„ íƒí•´ì£¼ì„¸ìš”!");
        return;
      }

      document.getElementById('mapBox').classList.add('show');
      document.getElementById('mapPlaceholder').style.display = 'none';

      map.setCenter(selectedCoords);
      marker.setPosition(selectedCoords);

      // ê¸°ì¡´ ì¸í¬ìœˆë„ìš° ë‹«ê¸° ê¸°ëŠ¥ì€ ì—†ìœ¼ë¯€ë¡œ ìƒˆë¡œ ìƒì„±
      new kakao.maps.InfoWindow({
        content: `<div style="width:150px;text-align:center;padding:6px 0;font-size:14px;">${selectedAddress}</div>`
      }).open(map, marker);

      setTimeout(() => {
        map.relayout();
        map.setCenter(selectedCoords);
      }, 100);

      isMapPreviewed = true;
      document.getElementById('btnSend').disabled = false;

      setTimeout(() => {
        document.getElementById('mapBox').scrollIntoView({ behavior: 'smooth', block: 'center' });
      }, 200);
    }
    window.showMapPreview = showMapPreview;


    // --- Firebase ì—°ë™ ì¶”ê°€ ---
    import { getDatabase, ref, set } from "https://www.gstatic.com/firebasejs/10.9.0/firebase-database.js";
    import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.9.0/firebase-auth.js";
    import { app } from "./js/firebase-config.js";

    const db = getDatabase(app);
    const auth = getAuth(app);

    async function goToMapView() {
      if (!isMapPreviewed) {
        alert("ë¨¼ì € 'ì§€ë„ ë¯¸ë¦¬ë³´ê¸°' ë²„íŠ¼ì„ ëˆŒëŸ¬ ì§€ë„ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”!");
        return;
      }

      if (!selectedAddress) {
        alert("ì¥ì†Œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”!");
        return;
      }

      const lat = selectedCoords.getLat();
      const lng = selectedCoords.getLng();
      const noticeText = document.getElementById('modalNotice').value.trim();

      // ë²„íŠ¼ ë¹„í™œì„±í™” (ì¤‘ë³µ í´ë¦­ ë°©ì§€)
      const btnSend = document.getElementById('btnSend');
      const originalText = btnSend.innerText;
      btnSend.disabled = true;
      btnSend.innerText = "â³ ì €ì¥ ì¤‘...";

      try {
        // 1. Firebase ìµëª… ë¡œê·¸ì¸ (ê¶Œí•œ í™•ë³´)
        await signInAnonymously(auth);

        // 2. Firebaseì— ë°ì´í„° ì €ì¥ (ê¸°ì¡´ ë°ì´í„° ë®ì–´ì“°ê¸°)
        await set(ref(db, 'terraone/map_data'), {
          addr: selectedAddress,
          lat: lat,
          lng: lng,
          notice: noticeText,
          updatedAt: new Date().toISOString()
        });

        console.log("âœ… Firebase ë°ì´í„° ì €ì¥ ì™„ë£Œ");

        // 3. ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ë„ ìœ ì§€ (í•˜ìœ„ í˜¸í™˜ì„±)
        localStorage.setItem('modalNoticeText', noticeText);
        localStorage.setItem('savedAddr', selectedAddress);
        localStorage.setItem('savedLat', lat);
        localStorage.setItem('savedLng', lng);

        // 4. í˜ì´ì§€ ì´ë™
        const url = `map_view.html?addr=${encodeURIComponent(selectedAddress)}&lat=${lat}&lng=${lng}`;
        location.href = url;

      } catch (error) {
        console.error("âŒ ë°ì´í„° ì €ì¥ ì‹¤íŒ¨:", error);
        alert(`ì§€ë„ë¥¼ ì €ì¥í•˜ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.\nì›ì¸: ${error.message}`);
        btnSend.disabled = false;
        btnSend.innerText = originalText;
      }
    }
    window.goToMapView = goToMapView;
  </script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>

</html>