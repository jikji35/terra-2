<!DOCTYPE html>
<html lang="ko">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>ëª¨ì„ ì¥ì†Œ ì•ˆë‚´</title>

  <link rel="icon" href="/favicon.png?v=2" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">

  <!-- âœ… [ìˆ˜ì •ë¨] autoload=false íŒŒë¼ë¯¸í„° ì¶”ê°€ -->
  <script
    src="//dapi.kakao.com/v2/maps/sdk.js?appkey=3409644aa1cb50eb41430562f5df97d2&libraries=services&autoload=false"></script>

  <style>
    /* ê¸°ë³¸ ìŠ¤íƒ€ì¼ */
    body {
      margin: 0;
      padding: 0;
      font-family: 'Noto Sans KR', sans-serif;
      background: #f9f9f9;
      color: #333;
    }

    .container {
      max-width: 600px;
      margin: 0 auto;
      padding: 20px;
      display: flex;
      flex-direction: column;
      min-height: 100vh;
      position: relative;
    }

    h2 {
      text-align: center;
      margin-bottom: 20px;
      font-size: 1.4rem;
      color: #2c3e50;
    }

    .map-container {
      width: 100%;
      height: 350px;
      border-radius: 15px;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
      overflow: hidden;
      margin-bottom: 20px;
      background: #eee;
    }

    .info-box {
      background: white;
      padding: 20px;
      border-radius: 15px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
      margin-bottom: 150px;
      /* ë²„íŠ¼ ê³µê°„ í™•ë³´ */
      text-align: center;
    }

    .place-name {
      font-size: 1.3rem;
      font-weight: bold;
      color: #1976d2;
      margin-bottom: 10px;
    }

    .notice-text {
      font-size: 0.95rem;
      line-height: 1.6;
      white-space: pre-line;
      text-align: left;
      color: #555;
      background: #f8f9fa;
      padding: 15px;
      border-radius: 10px;
    }

    /* ë‚´ë¹„ê²Œì´ì…˜ ë²„íŠ¼ ë ˆì´ì•„ì›ƒ (Grid) */
    .navi-buttons {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      width: 90%;
      max-width: 400px;
      z-index: 9999;
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }

    /* ê³µí†µ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
    .btn-navi {
      padding: 14px;
      border-radius: 12px;
      text-decoration: none;
      font-weight: bold;
      font-size: 16px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
      transition: transform 0.2s;
      border: none;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      cursor: pointer;
    }

    .btn-navi:active {
      transform: scale(0.96);
    }

    .btn-icon {
      width: 24px;
      height: 24px;
      object-fit: contain;
      border-radius: 4px;
    }

    .btn-kakao {
      background-color: #FEE500;
      color: #3C1E1E;
    }

    .btn-tmap {
      background-color: #004c97;
      color: #ffffff;
    }

    .btn-share {
      background: #34c759;
      color: white;
      grid-column: 1 / -1;
    }

    /* í•˜ë‹¨ ì „ì²´ ì°¨ì§€ */
  </style>
</head>

<body>
  <div class="container">

    <h2>ğŸ“ ëª¨ì„ ì¥ì†Œ ì•ˆë‚´</h2>

    <!-- ì§€ë„ ì˜ì—­ -->
    <div class="map-container" id="map"></div>

    <!-- ì •ë³´ ì˜ì—­ -->
    <div class="info-box">
      <div class="place-name" id="placeName">ë¡œë”© ì¤‘...</div>
      <div class="notice-text" id="noticeText"></div>
    </div>

    <!-- ë²„íŠ¼ ì˜ì—­ -->
    <div class="navi-buttons" id="naviBox">
      <!-- 1í–‰ ì¢Œì¸¡ -->
      <a href="#" id="kakaoLink" class="btn-navi btn-kakao" target="_blank">
        <img src="image/kakao_map.png" alt="kakao" class="btn-icon">
        ì¹´ì¹´ì˜¤ë§µ
      </a>

      <!-- 1í–‰ ìš°ì¸¡ -->
      <div id="tmapLink" class="btn-navi btn-tmap" onclick="tryRunTmap()">
        <img src="image/t_map.jpg" alt="tmap" class="btn-icon">
        TMAP ì‹¤í–‰
      </div>

      <!-- 2í–‰ ì „ì²´ -->
      <button class="btn-navi btn-share" onclick="shareUrl()">
        <i class="bi bi-share-fill"></i> ë§í¬ ê³µìœ í•˜ê¸°
      </button>
    </div>
  </div>

  <script type="module">
    import { getDatabase, ref, get } from "https://www.gstatic.com/firebasejs/10.9.0/firebase-database.js";
    import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.9.0/firebase-auth.js";
    import { app } from "./js/firebase-config.js";
    const db = getDatabase(app);
    const auth = getAuth(app);

    // ì „ì—­ í•¨ìˆ˜ ë“±ë¡
    window.tryRunTmap = tryRunTmap;
    window.shareUrl = shareUrl;

    // URL íŒŒë¼ë¯¸í„° ê°€ì ¸ì˜¤ê¸°
    function getQueryParam(name) {
      const urlParams = new URLSearchParams(window.location.search);
      return urlParams.get(name);
    }

    // ì§€ë„ ë° ë°ì´í„° ë¡œë“œ ë©”ì¸ ë¡œì§
    async function initMapPage() {
      let addr = getQueryParam('addr');
      let lat = parseFloat(getQueryParam('lat'));
      let lng = parseFloat(getQueryParam('lng'));
      let notice = "";

      try {
        // 1. Firebase ìµëª… ë¡œê·¸ì¸ (ì½ê¸° ê¶Œí•œ í™•ë³´)
        await signInAnonymously(auth);

        // 2. Firebaseì—ì„œ ë°ì´í„° ê°€ì ¸ì˜¤ê¸° (ê³µí†µ/ìµœì‹  ë°ì´í„°)
        const snapshot = await get(ref(db, 'terraone/map_data'));
        let dbData = null;
        if (snapshot.exists()) {
          dbData = snapshot.val();
        }

        // 3. ë°ì´í„° ìš°ì„ ìˆœìœ„ ê²°ì •
        // (1) URL íŒŒë¼ë¯¸í„°ê°€ ìˆëŠ” ê²½ìš° (ê³µìœ  ë§í¬) -> URL ë°ì´í„° ì‚¬ìš©
        if (addr && !isNaN(lat) && !isNaN(lng)) {
          // ê³µìœ  ë§í¬ì—ì„œëŠ” ì•ˆë‚´ë¬¸ë§Œ DBì—ì„œ ê°€ì ¸ì˜¤ê±°ë‚˜ ë¡œì»¬ ì‚¬ìš©
          notice = dbData ? dbData.notice : (localStorage.getItem('modalNoticeText') || "ë³„ë„ ì „ë‹¬ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤.");
        }
        // (2) URL íŒŒë¼ë¯¸í„°ê°€ ì—†ìœ¼ë©´ Firebase DB ë°ì´í„° ì‚¬ìš©
        else if (dbData) {
          addr = dbData.addr;
          lat = dbData.lat;
          lng = dbData.lng;
          notice = dbData.notice;

          // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ ë™ê¸°í™” (í•„ìš”ì‹œ)
          localStorage.setItem('savedAddr', addr);
          localStorage.setItem('savedLat', lat);
          localStorage.setItem('savedLng', lng);
          localStorage.setItem('modalNoticeText', notice);
        }
      } catch (e) {
        console.error("âŒ Firebase ë¡œë“œ ì‹¤íŒ¨:", e);
        // ì‹¤íŒ¨ ì‹œ ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ ìµœí›„ ìˆ˜ë‹¨ ì‚¬ìš©
        addr = addr || localStorage.getItem('savedAddr');
        lat = lat || parseFloat(localStorage.getItem('savedLat'));
        lng = lng || parseFloat(localStorage.getItem('savedLng'));
        notice = notice || localStorage.getItem('modalNoticeText') || "ë³„ë„ ì „ë‹¬ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤.";
      }

      // 4. ì•ˆë‚´ë¬¸ í‘œì‹œ
      document.getElementById('noticeText').innerText = notice || "ë³„ë„ ì „ë‹¬ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤.";

      // 5. ì§€ë„ ë Œë”ë§
      if (addr && !isNaN(lat) && !isNaN(lng)) {
        document.getElementById('placeName').innerText = addr;

        kakao.maps.load(function () {
          const mapContainer = document.getElementById('map');
          const mapOption = {
            center: new kakao.maps.LatLng(lat, lng),
            level: 3
          };
          const map = new kakao.maps.Map(mapContainer, mapOption);
          const marker = new kakao.maps.Marker({
            position: new kakao.maps.LatLng(lat, lng),
            map: map
          });
          new kakao.maps.InfoWindow({
            content: `<div style="padding:5px;text-align:center;width:150px;">${addr}</div>`
          }).open(map, marker);
        });

        document.getElementById('kakaoLink').href = `https://map.kakao.com/link/to/${addr},${lat},${lng}`;

        // ì „ì—­ ë³€ìˆ˜ ì—…ë°ì´íŠ¸ (Tmap/ê³µìœ ìš©)
        window.currentAddr = addr;
        window.currentLat = lat;
        window.currentLng = lng;

      } else {
        alert("ì €ì¥ëœ ì¥ì†Œ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.\në¨¼ì € ì¥ì†Œë¥¼ ê²€ìƒ‰í•´ì„œ ì§€ë„ë¥¼ ìƒì„±í•´ì£¼ì„¸ìš”.");
        document.getElementById('placeName').innerText = "ì¥ì†Œ ì •ë³´ ì—†ìŒ";
        document.getElementById('naviBox').style.display = 'none';
      }
    }

    // ì´ˆê¸°í™” ì‹¤í–‰
    initMapPage();

    // TMAP ì‹¤í–‰ í•¨ìˆ˜
    function tryRunTmap() {
      const { currentAddr: addr, currentLat: lat, currentLng: lng } = window;
      if (!addr || isNaN(lat) || isNaN(lng)) {
        alert("ìœ„ì¹˜ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.");
        return;
      }
      location.href = `tmap://route?goalname=${addr}&goalx=${lng}&goaly=${lat}`;
    }

    // (5) ê³µìœ í•˜ê¸° í•¨ìˆ˜
    function shareUrl() {
      const { currentAddr: addr, currentLat: lat, currentLng: lng } = window;
      const shareLink = `${window.location.origin}${window.location.pathname}?addr=${encodeURIComponent(addr)}&lat=${lat}&lng=${lng}`;

      if (navigator.share) {
        navigator.share({
          title: 'ëª¨ì„ ì¥ì†Œ ì•ˆë‚´',
          text: `[ëª¨ì„ì¥ì†Œ] ${addr}\nì•„ë˜ ë§í¬ë¥¼ ëˆŒëŸ¬ í™•ì¸í•˜ì„¸ìš”!`,
          url: shareLink,
        })
          .catch((error) => console.log('ê³µìœ  ì‹¤íŒ¨', error));
      } else {
        const dummy = document.createElement("textarea");
        document.body.appendChild(dummy);
        dummy.value = shareLink;
        dummy.select();
        document.execCommand("copy");
        document.body.removeChild(dummy);
        alert("URLì´ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤. ì¹´í†¡ ë“±ì— ë¶™ì—¬ë„£ê¸° í•˜ì„¸ìš”!");
      }
    }
  </script>
</body>

</html>